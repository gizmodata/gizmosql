name: ci

on:
  workflow_dispatch:
    inputs:
      cmake_build_type:
        description: "The CMake build type to use"
        type: choice
        required: true
        default: Release
        options:
          - Release
          - Debug
          - RelWithDebInfo
  push:

env:
  DOCKERHUB_IMAGE_NAME: gizmodata/gizmosql
  GITHUB_IMAGE_NAME: ghcr.io/gizmodata/gizmosql
  CMAKE_BUILD_TYPE: ${{ github.event.inputs.cmake_build_type || 'Release' }}

jobs:
  build-project-macos:
    name: Build Project - MacOS
    runs-on: macos-14-xlarge
    env:
      zip_file_name: gizmosql_cli_macos_arm64.zip
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build requirements
        env:
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
        run: |
          brew install automake boost gflags

      - name: Configure Project
        uses: threeal/cmake-action@v2.1.0
        with:
          generator: Ninja
          run-build: true
          options: |
            GIZMOSQL_ENTERPRISE=ON

      - name: Run Tests (Core Edition - No License)
        run: |
          ./build/tests/gizmosql_integration_tests

      - name: Setup Enterprise License
        env:
          GIZMOSQL_LICENSE_KEY: ${{ secrets.GIZMOSQL_LICENSE_KEY }}
        if: env.GIZMOSQL_LICENSE_KEY != ''
        run: |
          echo "$GIZMOSQL_LICENSE_KEY" > /tmp/gizmosql_license.jwt
          echo "GIZMOSQL_LICENSE_KEY_FILE=/tmp/gizmosql_license.jwt" >> $GITHUB_ENV

      - name: Run Tests (Enterprise Edition - With License)
        env:
          GIZMOSQL_LICENSE_KEY: ${{ secrets.GIZMOSQL_LICENSE_KEY }}
        if: env.GIZMOSQL_LICENSE_KEY != ''
        run: |
          ./build/tests/gizmosql_integration_tests

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Python Tests (macOS)
        run: |
          python3 -m venv /tmp/test_venv
          source /tmp/test_venv/bin/activate
          pip install adbc-driver-flightsql geopandas shapely pyarrow duckdb

          # Start server in background
          ./build/gizmosql_server --password gizmosql_password &
          SERVER_PID=$!
          sleep 5

          # Run Python tests
          python tests/test_geoarrow.py
          python tests/test_bulk_ingest.py
          TEST_EXIT_CODE=$?

          # Stop server
          kill $SERVER_PID 2>/dev/null || true

          exit $TEST_EXIT_CODE

      - name: Sign and notarize the server release build
        uses: toitlang/action-macos-sign-notarize@v1.2.1
        with:
          certificate: ${{ secrets.APPLE_CERTIFICATE }}
          certificate-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          username: ${{ secrets.APPLE_ID_USERNAME }}
          password: ${{ secrets.APPLE_ID_PASSWORD }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
          app-path: build/gizmosql_server
          entitlements-path: macos/entitlements.plist

      - name: Sign and notarize the server release build
        uses: toitlang/action-macos-sign-notarize@v1.2.1
        with:
          certificate: ${{ secrets.APPLE_CERTIFICATE }}
          certificate-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          username: ${{ secrets.APPLE_ID_USERNAME }}
          password: ${{ secrets.APPLE_ID_PASSWORD }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
          app-path: build/gizmosql_client

      - name: Zip artifacts
        run: |
          mv build/gizmosql_server build/gizmosql_client .
          zip -j ${{ env.zip_file_name }} gizmosql_server gizmosql_client

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_file_name }}
          path: |
            ${{ env.zip_file_name }}

  build-project-linux:
    name: Build Project - Linux
    strategy:
      matrix:
        include:
          - platform: amd64
            os: linux
            runner: buildjet-8vcpu-ubuntu-2204
          - platform: arm64
            os: linux
            runner: buildjet-8vcpu-ubuntu-2204-arm
    runs-on: ${{ matrix.runner }}
    env:
      zip_file_name: gizmosql_cli_${{ matrix.os }}_${{ matrix.platform }}.zip
    services:
      # PostgreSQL for general DuckLake tests
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: ducklake_catalog
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      # PostgreSQL for instrumentation tests (isolated)
      postgres-instrumentation:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: instrumentation_catalog
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      # MinIO for S3-compatible object storage (instrumentation data)
      minio:
        image: bitnami/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build requirements
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ninja-build \
            automake \
            cmake \
            gcc \
            git \
            libboost-all-dev \
            libgflags-dev \
            libssl-dev \
            zlib1g-dev
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Configure Project
        uses: threeal/cmake-action@v2.1.0
        with:
          generator: Ninja
          run-build: true
          options: |
            CMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }}
            GIZMOSQL_ENTERPRISE=ON

      - name: Setup MinIO bucket
        run: |
          # Install MinIO client (architecture-aware)
          ARCH=$(uname -m)
          if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            MC_ARCH="arm64"
          else
            MC_ARCH="amd64"
          fi
          curl -sL "https://dl.min.io/client/mc/release/linux-${MC_ARCH}/mc" -o /tmp/mc
          chmod +x /tmp/mc
          # Configure and create bucket (with retry for service startup)
          for i in {1..10}; do
            /tmp/mc alias set myminio http://localhost:9000 minioadmin minioadmin && break
            echo "Waiting for MinIO to be ready... (attempt $i)"
            sleep 2
          done
          /tmp/mc mb --ignore-existing myminio/instrumentation

      - name: Run Tests (Core Edition - No License)
        run: |
          ./build/tests/gizmosql_integration_tests

      - name: Setup Enterprise License
        env:
          GIZMOSQL_LICENSE_KEY: ${{ secrets.GIZMOSQL_LICENSE_KEY }}
        if: env.GIZMOSQL_LICENSE_KEY != ''
        run: |
          echo "$GIZMOSQL_LICENSE_KEY" > /tmp/gizmosql_license.jwt
          echo "GIZMOSQL_LICENSE_KEY_FILE=/tmp/gizmosql_license.jwt" >> $GITHUB_ENV

      - name: Run Tests (Enterprise Edition - With License)
        env:
          GIZMOSQL_LICENSE_KEY: ${{ secrets.GIZMOSQL_LICENSE_KEY }}
        if: env.GIZMOSQL_LICENSE_KEY != ''
        run: |
          ./build/tests/gizmosql_integration_tests

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run Python Tests (Linux)
        run: |
          python3 -m venv /tmp/test_venv
          source /tmp/test_venv/bin/activate
          pip install adbc-driver-flightsql geopandas shapely pyarrow duckdb

          # Start server in background
          ./build/gizmosql_server --password gizmosql_password &
          SERVER_PID=$!
          sleep 5

          # Run Python tests
          python tests/test_geoarrow.py
          python tests/test_bulk_ingest.py
          TEST_EXIT_CODE=$?

          # Stop server
          kill $SERVER_PID 2>/dev/null || true

          exit $TEST_EXIT_CODE

      - name: Zip artifacts
        run: |
          mv build/gizmosql_server build/gizmosql_client .
          zip -j ${{ env.zip_file_name }} gizmosql_server gizmosql_client

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.zip_file_name }}
          path: |
            ${{ env.zip_file_name }}

      - name: Sanitize ref name for Docker tags
        id: sanitize
        run: |
          # Replace / with - to make valid Docker tag
          SANITIZED_REF=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
          echo "ref_name=${SANITIZED_REF}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push full Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/${{ matrix.platform }}
          file: Dockerfile.ci
          push: ${{ startsWith(github.ref, 'refs/tags/') }}
          tags: |
            ${{ env.DOCKERHUB_IMAGE_NAME }}:latest-${{ matrix.platform }}
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ steps.sanitize.outputs.ref_name }}-${{ matrix.platform }}
            ${{ env.GITHUB_IMAGE_NAME }}:latest-${{ matrix.platform }}
            ${{ env.GITHUB_IMAGE_NAME }}:${{ steps.sanitize.outputs.ref_name }}-${{ matrix.platform }}
          no-cache: true
          provenance: false

      - name: Build and push slim Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/${{ matrix.platform }}
          file: Dockerfile-slim.ci
          push: ${{ startsWith(github.ref, 'refs/tags/') }}
          tags: |
            ${{ env.DOCKERHUB_IMAGE_NAME }}:latest-${{ matrix.platform }}-slim
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ steps.sanitize.outputs.ref_name }}-${{ matrix.platform }}-slim
            ${{ env.GITHUB_IMAGE_NAME }}:latest-${{ matrix.platform }}-slim
            ${{ env.GITHUB_IMAGE_NAME }}:${{ steps.sanitize.outputs.ref_name }}-${{ matrix.platform }}-slim
          no-cache: true
          provenance: false

  create-release:
    name: Create a release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-project-macos, build-project-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: gizmosql_cli_*.zip
          merge-multiple: true

      - name: Attest build provenance - Linux AMD64
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/gizmosql_cli_linux_amd64.zip

      - name: Attest build provenance - Linux ARM64
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/gizmosql_cli_linux_arm64.zip

      - name: Attest build provenance - macOS ARM64
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/gizmosql_cli_macos_arm64.zip

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/gizmosql_cli_*.zip
            LICENSE

  update-image-manifest:
    name: Update DockerHub image manifest to include all built platforms
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-project-linux
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push full manifest images - DockerHub
        uses: Noelware/docker-manifest-action@0.4.3
        with:
          inputs: ${{ env.DOCKERHUB_IMAGE_NAME }}:latest,${{ env.DOCKERHUB_IMAGE_NAME }}:${{ github.ref_name }}
          images: ${{ env.DOCKERHUB_IMAGE_NAME }}:latest-amd64,${{ env.DOCKERHUB_IMAGE_NAME }}:latest-arm64
          push: true

      - name: Create and push slim manifest images - DockerHub
        uses: Noelware/docker-manifest-action@0.4.3
        with:
          inputs: ${{ env.DOCKERHUB_IMAGE_NAME }}:latest-slim,${{ env.DOCKERHUB_IMAGE_NAME }}:${{ github.ref_name }}-slim
          images: ${{ env.DOCKERHUB_IMAGE_NAME }}:latest-amd64-slim,${{ env.DOCKERHUB_IMAGE_NAME }}:latest-arm64-slim
          push: true

      # ------------------------------------------------------------------
      - name: Create and push full manifest images - Github
        uses: Noelware/docker-manifest-action@0.4.3
        with:
          inputs: ${{ env.GITHUB_IMAGE_NAME }}:latest,${{ env.GITHUB_IMAGE_NAME }}:${{ github.ref_name }}
          images: ${{ env.GITHUB_IMAGE_NAME }}:latest-amd64,${{ env.GITHUB_IMAGE_NAME }}:latest-arm64
          push: true

      - name: Create and push slim manifest images - Github
        uses: Noelware/docker-manifest-action@0.4.3
        with:
          inputs: ${{ env.GITHUB_IMAGE_NAME }}:latest-slim,${{ env.GITHUB_IMAGE_NAME }}:${{ github.ref_name }}-slim
          images: ${{ env.GITHUB_IMAGE_NAME }}:latest-amd64-slim,${{ env.GITHUB_IMAGE_NAME }}:latest-arm64-slim
          push: true

  update-homebrew-tap:
    name: Update Homebrew tap
    if: startsWith(github.ref, 'refs/tags/')
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all CLI artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: gizmosql_cli_*.zip
          merge-multiple: true

      - name: Calculate SHA256 checksums
        id: checksums
        run: |
          MACOS_ARM64_SHA=$(sha256sum artifacts/gizmosql_cli_macos_arm64.zip | cut -d ' ' -f 1)
          LINUX_ARM64_SHA=$(sha256sum artifacts/gizmosql_cli_linux_arm64.zip | cut -d ' ' -f 1)
          LINUX_AMD64_SHA=$(sha256sum artifacts/gizmosql_cli_linux_amd64.zip | cut -d ' ' -f 1)
          echo "macos_arm64_sha=${MACOS_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=${LINUX_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_amd64_sha=${LINUX_AMD64_SHA}" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: gizmodata/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ github.ref_name }}
          MACOS_ARM64_SHA: ${{ steps.checksums.outputs.macos_arm64_sha }}
          LINUX_ARM64_SHA: ${{ steps.checksums.outputs.linux_arm64_sha }}
          LINUX_AMD64_SHA: ${{ steps.checksums.outputs.linux_amd64_sha }}
        run: |
          VERSION_NUMBER=${VERSION#v}
          cat > homebrew-tap/Formula/gizmosql.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Gizmosql < Formula
            desc "High-performance SQL server built on DuckDB/SQLite with Arrow Flight SQL"
            homepage "https://github.com/gizmodata/gizmosql"
            version "VERSION_PLACEHOLDER"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/gizmodata/gizmosql/releases/download/vVERSION_PLACEHOLDER/gizmosql_cli_macos_arm64.zip"
                sha256 "MACOS_ARM64_SHA_PLACEHOLDER"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/gizmodata/gizmosql/releases/download/vVERSION_PLACEHOLDER/gizmosql_cli_linux_arm64.zip"
                sha256 "LINUX_ARM64_SHA_PLACEHOLDER"
              elsif Hardware::CPU.intel?
                url "https://github.com/gizmodata/gizmosql/releases/download/vVERSION_PLACEHOLDER/gizmosql_cli_linux_amd64.zip"
                sha256 "LINUX_AMD64_SHA_PLACEHOLDER"
              end
            end

            def install
              bin.install "gizmosql_server"
              bin.install "gizmosql_client"
            end

            def caveats
              <<~EOS
                GizmoSQL server can be started with:
                  GIZMOSQL_PASSWORD=tiger gizmosql_server --database-filename /path/to/database.duckdb --username scott

                GizmoSQL client can connect with:
                  gizmosql_client --host localhost --port 31337 --username scott --password tiger --command Execute --query "SELECT 1"

                For TLS and authentication options, see:
                  gizmosql_server --help
                  gizmosql_client --help
              EOS
            end

            test do
              assert_match "gizmosql_server", shell_output("#{bin}/gizmosql_server --help 2>&1", 1)
            end
          end
          FORMULA_EOF
          sed -i "s/VERSION_PLACEHOLDER/${VERSION_NUMBER}/g" homebrew-tap/Formula/gizmosql.rb
          sed -i "s/MACOS_ARM64_SHA_PLACEHOLDER/${MACOS_ARM64_SHA}/g" homebrew-tap/Formula/gizmosql.rb
          sed -i "s/LINUX_ARM64_SHA_PLACEHOLDER/${LINUX_ARM64_SHA}/g" homebrew-tap/Formula/gizmosql.rb
          sed -i "s/LINUX_AMD64_SHA_PLACEHOLDER/${LINUX_AMD64_SHA}/g" homebrew-tap/Formula/gizmosql.rb

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gizmosql.rb
          git commit -m "Update gizmosql to ${{ github.ref_name }}"
          git push